计算机工程
Computer Engineering
1999年　第25卷　第9期　Vol.25 No.9  1999



使用协议分析预警、排除Novell网络故障
李德鹏　史清华
　　摘　要：针对Novell网络，介绍如何使用Novell网络操作系统的一些特殊性质协议，预警网络异常情况．网络管理员可以以此为依据，防患于未然．然后进一步讨论如何利用Novell网络协议定位网络故障，并且提供几个网络故障排除的例子．
　　关键词：NetWare网络操作系统；Watch dog协议；故障预警；故障排除
Alarm and Troubleshooting Novell Network with NetWare Protocol
Li Depeng
(Computer Center of Shandong Prov. Network Key Lab of Shandong Prov. Jinan 250014)
Shi Qinghua
(Department of Computer, Shandong Indutrial University, Jinan 250014)
　　Abstract　This Article talked about how to alarm and troubleshoot Novell network with NetWare protocol. The Network administrator can prevent network form been damaged. And it gives some sample to discuss about.
　　Key words　NetWare network; Watch dog protocol; Alarm; Troubleshooting
　　由于NetWare网络操作系统没有提供网络故障诊断工具，所以网络管理人员如何有效快速定位解决这些故障，以避免更大经济损失是迫切需要解决的问题。NetWare网络操作系统提供许多协议用于服务器与工作站之间有关异常情况的磋商、对话，对网络故障预警、排除都有所帮助。结合网络故障解决的实际经验，讲述如何使用Novell的网络协议定位、排除故障，解决问题。
1　NetWare的重要协议
1.1　基本帧格式
　　NetWare网络操作系统支持4种不同的以太网帧结构。分别称为"Ethernet_802.3"、 "Ethernet_802.2"、"Ethernet_SNAP"、 "Ethernet_II"。通常人们使用"Ethernet_802.3"、 "Ethernet_802.2"支持IPX/SPX协议，使用"Ethernet_II"支持TCP/IP协议，而用"Ethernet_SNAP"支持Apple Talk协议。
　　由于 NetWare网络要求，工作站和服务器只能使用相同帧格式，双方才可以通信。所以如果工作站使用不同于服务器的帧格式，必然导致工作站无法同服务器建立连接，也就是工作站得到"File Server has not been found"的提示。
　　下面简要介绍4种不同的帧格式，解决工作站无法找到服务器的问题。
　　(1) Ethernet_802.3
前辍/SFD(8字节)目的地址(6字节)源地址(6字节)长度(2字节)
上层协议类型(2字节)　

　　(注解：上层协议类型是0XFFFF表示为IPX协议头)
　　(2) Ethernet_802.2
前辍/SFD(8字节)目的地址(6字节)源地址(6字节)长度(2字节)
DSAP(2字节)SSAP(2字节)控制(2字节)上层协议类型(2字节)

　　DSAP指明数据包目的地上层(网络层)协议的类型。E0表示是IPX/SPX类型。
　　SSAP指明数据包源地址上层(网络层)协议的类型。E0表示是IPX/SPX类型。
　　如果使用NetWare的IPX/SPX协议，并且控制域的数值为0X03时，表示不编号，意味着LLC层提供无连接服务。
前辍/(8字节)目的地址(6字节)源地址(6字节)长度(2字节)
DSAP(1字节)SSAP(1字节)控制(1字节)组织代码(1字节)　
Ethernet类型(2字节)　

　　(3) Ethernet _SNAP
　　DSAP字段长度为1字节，值为0XAA表示帧格式是SNAP，控制域为0X03表示无连接组织代码为"000000"表示该帧是NetWare的IPX/SPX数据包。Ethernet类型字段的功能是规定上层协议，NetWare的Ethernet数是0X8317。详见表1。
表1 各种协议的数值对照表
协议名称数值
IP0X0800
ARP0X0806
PARP0X8035
Apple Talk0X809B
Apple Talk arp0X80f3
NetWare IPX/SPX0X8137

　　(4) Ethernet_II
前辍/SFD(8字节)目的地址(6字节)源地址(6字节)类型(2字节)

　　EtherNet_II与前3种不同，前3种帧格式的源地址字段后是长度字段，而EtherNet_II是类型字段，类型字段的数值所表示的协议类型见表1。
1.2 延迟帧
　　NetWare中，NCP(NetWare核心协议)是用IPX/SPX协议封装的。NCP请求是工作站请求服务器进行文件读写、创建队列作业、决定驱动映射、搜索目录等。服务器用NCP应答NCP请求。其中应答类型是"9999"的协议表示工作站的请求正在被处理。该类帧也被称作延迟帧(Requesting Being Proceed)。帧格式如下：
以太网数据头IPX数据头SPX数据头NCP请求头标NCP数

　　以太网数据头见1.1所述的几种帧格式。
　　IPX数据头：
校验和(2字节)长度(2字节)传输控制(1字节)
分组类型(2字节)目的节点地址(6字节)
目的网络地址(4字节)目的Scoket(2字节)源节点地址(字节)
源网络地址(4字节)源Scoket(2字节)

　　SPX数据头：
连接控制(2字节)数据流控制(1字节)源连接(2字节)目的连接(2字节)
顺序号(2字节)确认号(2字节)分配数(2字节)　

　　NCP应答头标：
请求类型(2字节)顺序号(1字节)连接号低字串(1字节)任务号(1字节)
连接号高字节(1字节)完成码(1字节)连接状态(1字节)　

　　客户机传送请求至服务器，然后等待服务器应答。如果超时限度内没有收到应答就重新发送。如果服务器太忙，无法处理客户机的该请求，就发送NCP应答类型是"9999"的数据包，表示请求正在处理。客户机收到该请求正在处理数据包，复位IPX超时计数器并继续等待超载服务器的应答。
　　若网络出现延迟数据包，说明有NetWare服务器运行在超负载情况下，正在处理工作站的请求，希望工作站等待。
　　． Watchdog 分组
　　Watchdog 分组是服务器用来同工作站保持连接的协议。在Novell环境中，工作站同服务器之间存在连接。如果很长时间双方没有通信，为了确认客户机依然存在，没有Down机，NetWare服务器向工作站发送Watchdog 协议。如果工作站在一定时间(默认时间是4分钟56.6 秒)不向服务器发送任何分组，服务器将向工作站发送Watchdog 协议分组。分组的数据格式如下：
帧头IPX头连接号(1字节)签名字符域(1字节)

　　如果服务器没有收到来自工作站的应答，会发送10组附加的Watchdog分组，间隔时间(默认值)为59.3s。如果工作站不响应，则服务器终止该工作站的连接。
　　Nowvell用户可以通过下列语法修改分组发送间隔：
　　Set Number of Watchdog Packets　　 　　　= n
　　Set Delay Between Watchdog Packets　　　= n
　　Set Delay Before First Watchdog Packets　= n
2　网络故障预警、排除的实现
　　系统采用予留缓冲区扑获数据、协议解码、统计重要协议数据包的方法，统计异常网络协议传送数量、比例，并且根据经验预警网络故障，排除网络故障。
2.1 使用前过滤机制，捕获预定数据包
　　考察前过滤、后过滤机制、硬件平台的普遍性、予留数据缓冲区，有针对性地截获发送特殊协议的数据包，给出屏幕提示以及响应的统计数据，作为网络管理人员监控网络、排除差错的依据。
2.2 列出服务器名称和所用网卡封装的帧格式
　　根据网络服务器所发送的广播包，分析解码协议帧，列出服务器名称以及所使用的帧格式。在服务器、工作站、中间连接设备都正常的情况下，有时会出现工作站无法连接服务器的问题。导致这种情况的原因很多，其中由于工作站、服务器所使用的帧格式不同而导致出现该问题占的比例很大。如果服务器网卡使用的帧格式为EtherNet_802.3，而工作站使用的帧格式为EtherNet_802.2,由此造成相互无法发现彼此的存在。根据屏幕列出的服务器名称及所使用的数据帧，判断是否存在这种情况。
　　另外，造成工作站无法连接服务器的原因还有网卡硬件故障、电缆链路质量、网卡驱动程序配置等。值得一提的是由于服务器License许可证数量不足，造成工作站无法登录服务器，但有趣的是工作站得到的提示为"A File Server Could not be found"。例如，在一次故障排除中碰到这种情况：在增加几十台工作站之后，突然之间不时有工作站无法登录服务器，而且工作站的型号、网卡的型号、用户名称各不相同，后来才发现该服务器是100用户版，而当时使用的工作站超过100台。
2.2 统计延迟帧发送的数量及占网络数据帧总量的比例
　　凭借检测到该类数据包进行网络故障定位、排除很有效。如果延迟帧占数据帧总量的比例大于5%，系统应弹出报警信号。提示网络管理人员：网络处于超负载状况。
　　一个实际网络故障排除的例子是：某网络运行速度很慢，经检查服务器发现服务器的CPU和硬盘的利用率都很低，服务器中的缓存也充足。服务器采用100M快速以太网卡，针对网络数据流量测试后发现数据流量占总带宽的1%，所有这一切都不应造成网络瓶颈，但是，工作站在同服务器进行数据传输的过程中速度很慢。
　　根据协议分析的方法，在网络上发现大量的延迟数据包，这同前面的分析恰恰相反，说明网络服务器在重负荷下工作，由于CPU、硬盘、缓存都宽裕，所以可能是网卡造成网络数据传输瓶颈。由于采用100M网卡，所以网卡速度慢的可能性也排除。检查网卡驱动程序，发现由于驱动程序过时导致配置不当，使得数据发送不及时，造成延迟，才发送大量的延迟数据包。
2.3 监视Watchdog数据包
　　频繁多次收到Watchdog数据包，而工作站没有作出反映，系统应提示网络连接可能发生中断，工作站可能掉网。
　　曾碰到一例网络故障：某单位的网络升级改造完成后，出现异常现象。登录服务器的工作站常与服务器失去连接，也就是通常所说的间歇性掉网。一般时间是登录服务器半小时左右。用户不得不多次启动工作站。严重降低办公效率。
　　使用协议分析的方法进行检查，发现工作站登录服务器后不久就不再向服务器发送数据包，4-5分钟后，服务器向工作站发送Watchdog 分组，工作站也没有进行响应。由此初步判定故障出在工作站一端。由于网络升级以前，网络工作正常，对原系统进行协议分析，发现工作站的响应方式正常。网络升级针对工作站一端所做工作在于网卡由10M升级至100M，由ODI方式改为VLM方式。进一步使用替换排错的方法定位问题出在VLM方式与网卡的互操作上，由于存在漏洞，所以造成一段时间之后，网卡无法发送数据。
3　小结
　　因为导致Novell网络故障发生的可能性成千上万。本文提出根据网络协议预警网络故障的办法仅仅能够解决一小部分问题。对网络管理人员来说，留心重要的可以报警异常情况的协议格式，在网络异常的情况下，采用协议分析的方法可以迅速定位网络故障，为网络排错。
作者简介：李德鹏(1970～)，男，助理研究员，主要研究方向为计算机检测评估
作者单位：李德鹏　山东省计算中心，山东省网络重点实验室，济南　250014
　　　　　史清华　山东工业大学计算机系，济南　250014
参考文献
1 Chappell A, Hakes E.The Complete Guide to NetWare LAN Analysis(3rd ED). 1997
2 Allen N. Network Maintence and Troubleshooting Guide. 1997
收稿日期：1998-11-30
