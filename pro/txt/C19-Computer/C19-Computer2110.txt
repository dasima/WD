计算机工程
COMPUTER ENGINEERING
1999年 第25卷 第12期 vol.25 No.12 1999



具有真实感的虚拟装备生成方法
刘鹏远　张锡恩　杨军
　　使用三维建模工具建立三维模型，然后将其输出至开发环境，是实现导弹武器系统虚拟装备的一个重要环节。目前，有帮助用户直接从3DS MAX输出成Playstation、Sega Saturn、DirectDraw格式的外挂模块。许多前期制作的实时三维应用编程接口提供3DS或者DXF格式的专用转换器，但是这些工具对三维模型细节操作的功能相对较差，而且通用性不是很好。在系统中，开发了一个比较灵活并且通用性较好的转换工具，利用这个工具实现了从三维建模工具到开发环境的平滑、不失真转换。系统使用的三维建模工具是3DS MAX，它的输出形式是DXF格式文件；而在Windows NT 环境下使用的三维图形工具则是OpenGL，系统工作流程图如图1所示。

图1 系统工作流程图
　　DXF 文件是AutoDesk 公司推出的一种主要用于AutoCAD 系统的图形交换文件格式，具有容易阅读、易于程序处理、命令直接输入输出等优点，因此在各类图形系统中得到了广泛的应用，已成为事实上的工业标准。OpenGL是近几年发展起来的性能卓越的三维图形标准，它是在SGI 等多家世界闻名的计算机公司的倡导下，以SGI的GL 三维图形库为基础制定的一个通用共享开放式图形标准。它独立于窗口系统和操作系统，以它为基础开发的应用程序可以十分方便地在各种平台间移植。
1 DXF 文件分析及读取
　　一个DXF文件包含有Header(标题节)、Tables(表节)、Blocks(块节)、Entitles(实体节)、End of file(文件结束标志)等组成部分，其中实体节存储着三维实体的几何要素及拓扑结构，是主要分析的对象。以在3DS MAX 中建立导弹发射车为例，它包含数十个实体，如Line、Circle、Loft、Box等，具体分析DXF文件是怎样实现几何要素和拓扑结构的存储的。
1.1 DXF文件中几何要素的描述
　　在实体节中，可以包含各种基本绘图实体的描述，如Line、Circle、Triangle、Arc、Point、Trace、Solid、Text、Vertex等。导弹发射车包含许多实体，每一个实体都由若干个三角形构成，而对三角形的描述则是通过对顶点的描述来实现的，以下一段代码取自对导弹发射车车轮Truckwheel实体的描述，具体形式为：
…
0
VERTEX标记该几何要素为顶点类型
8
TRUCKWHEEL该要素属于TRUCKWHEEL
10
30.409454X轴坐标
20
150.75253Y轴坐标
30
-48.537918Z轴坐标
70
192几何要素描述标志
…

1.2 DXF文件中拓扑结构的描述
　　只有了解几何要素的拓扑结构，才能将一个个的几何要素组织起来，成为三维实体。在DXF文件中用三角形近似组成三维实体，这是因为除三角形外的多边形和顶点可能不共面，有时不是简单多边形，使OpenGL不能正常工作。仍以Truckwheel实体为例，其拓扑结构的描述如下：
…
0
VERTEX描述的是顶点的拓扑结构
8
TRUCKWHEEL这些顶点属于TRUCKWHEEL
10
0
20
0
30
0
70
128拓拟结构描述志
71
235按逆时针方向，指定三角形的三个顶点，序号
72代表在几何要素描述中顶点出现的顺序
234
73
230
…

2 图形数据库
　　为了便于图形数据的维护管理，提高对图形数据处理的速度，实现图形由场景→实体→几何要素的存储体系，系统开发了一个针对DXF文件的基于关系数据库的图形数据库管理系统，实现对几何要素和拓扑结构的分类存储，并装配多媒体信息。
　　开发图形数据库是系统的一个特色，它具有几项优点：数据模式完整；数据维护容易，便于实现对图形数据的增加、删除、查询操作；多用户并发控制，安全性、完整性控制均能得到保证；数据层次清晰，易于实现对数据的细节操作，数据定位的层次可以到点级。
　　在进行图形库设计时，构建了一个包括场景表(Scene)、实体表(Solid)、几何要素表(Source)、拓扑结构表(Destination)、纹理表(Texture)、媒体信息表(Multimedia)、索引表(Index)的数据库，实现对图形数据的存储及在Windows NT下媒体及纹理的装配。如图2。

图2 图形库结构图
3 利用OpenGL再现三维模型法
　　线矢量的计算方法：对于由空间三角形构成的导弹武器系统虚拟设备，要将它显示为具有真实感的图形需要进行一系列可视化处理过程。其中包括建立光照模型、进行表面法向量计算、纹理映射等，在这里只介绍表面法向量的计算方法。

图3 计算法线向量的示意图
　　三维虚拟设备是由空间多边形构成的。当采用OpenGL提供的光照模型照亮它时，只要知道网格体表面某一点的法向量，就可算出该点的明暗程度。OpenGL是采用冯氏阴影法(Phong shading)计算明暗程度的，但是顶点法向量的计算却不是自动完成的，必须由程序员自己定义。为了保证生成具有真实感的图形，需要根据三角面所处的位置，决定其法向量的计算方法。根据构成几何体的三角面所处位置的不同，分两种情况进行考虑：
　　(1) 对于变化比较剧烈区域的三角面, 直接计算三角面法线矢量，并将其作为各顶点的法向量。由于图形数据库的引入，致使数据的层次结构更清晰，为查询变化比较剧烈区域的顶点提供了方便。查询顺序如图4。

图4 查询顺序
　　法向量计算方法：v1,v2,v3为三角面的3个顶点，其叉积[v1- v2]×[v2- v3]为各顶点的法向量。如图3中的R点要分别处理交界面上的法线。
　　(2) 对于构成光滑曲面的三角面，若采用以上方法计算法向量，由于每个平面上所有点的法向量相同，而不同平面块之间存在不连续的法向量跳跃，当网格体中相邻的两个平面多边形的法向量变化很大，就会产生明显的拼接痕迹，显示图形的真实感会降低。为了生成具有光滑变化且有明暗程度的真实感图形，这里对计算法向量的算法进行改进。
　　如图3所示，为了计算P点的法向量，首先用上述的方法计算相邻各三角面的法线矢量n1，n2，n3，n4，n5，n6，然后为避免在相邻平面上某个法线值过大，将求出的n1+n2+n3+n4做归一化处理，即为P点的法线。
　　使用以上方法，实现了具有真实感的导弹武器系统虚拟装备的生成，这种方法对于建立大型智能维修训练和仿真系统的可视化环境将会有一定的参考作用。
作者单位：军械工程学院导弹工程系，石家庄050003
参考文献
1 Hearn D,Baker M P.计算机图形学.北京：电子工业出版社, Prentice Hall 出版公司,1998
2 白燕斌,史惠康.OpenGL三维图形库编程指南.北京：机械工业出 版社,1998
