计算机应用研究
APPLICATION RESEARCH OF COMPUTERS
2000　Vol.17　No.5　P.20-22



基于景物特征的粒子系统建模技术
杨冰　鲁敏
摘  要  提出一种基于景物特征的粒子系统建模技术。与传统的粒子系统建模方法不同，该算法首先提取景物特征，然后就特征点以粒子表示和实现，其余部分利用特征的空间相关性插值得到。利用该技术，可以方便解决传统的粒子系统建模中，大运算量和大存储量问题。实验表明，该方法可在微机环境实现不规则模糊景物的实时动态生成和显示。
关键词  粒子系统  特征  实时  火焰模拟
1  引言
　　在现实世界中，自然景物常常具有极其丰富的表面纹理细节和不规则的表面外形。在对这些景物的计算机模拟过程中，如果仅仅采用传统的计算机图形学方法对表面细节一一进行造型，然后再场景绘制、渲染显然不切实际。由于人眼的分辨率和计算机显示器的分辨率是有限的，场景中过分详尽的细节并不会增加人对场景景物的理解；并且，对在微机条件下场景的实时生成，巨大的计算量往往使之成为图形生成显示的瓶颈，因此，如何简化且有效地模拟如火焰、烟云等自然景物成为计算机真实感图形生成的关键技术。
　　为了用计算机绘制出各种真实的自然景物，需要对景物的不规则表面(几何纹理)进行有效地表示及绘制。近年来国内外主要集中在两个方面的研究：一种是对常规景物模型进行随机扰动，从而获得不规则的景物表面形状；第二种就是所谓算法模型，即通过使用一种递归模式，引入随机变量，实现对不规则物体的造型。几种成功的模拟不规则景物表面的方法如：Blinn在1978年提出的法向扰动法[１]，主要用于模拟表面细微的凹凸不平的景物；fBm方法[６]，它使用随机过程来模拟不规则物体，很好地描述了许多自然现象(如地域、星球表面、山脉、丛林等)；W.T.Reeves在1983年提出的粒子系统方法[2,3]，它不同于传统的图形学方法，充分体现了不规则模糊物体的动态性和随机性，很好地模拟了火、云、水、森林和原野等许多自然景象。
　　由于粒子系统考虑物体由许多形状简单的(如点、小立方体、小球体等)的微小粒子单元构成，因而对于空间中一个不大的体区域，构成它的粒子数目却是惊人的。传统的粒子系统方法对计算机的存储量和计算速度要求过高，使得图形实时交互显示在微机环境下一般不可能实现。本文采用在三维物体表面提取特征点，并利用物体特征的空间连续性，改进传统的粒子系统方法，提出基于景物特征的粒子系统建模算法，方便地实现微机环境下的模糊不规则物体的实时生成和显示。
2  粒子系统基本原理
　　粒子系统的基本设计思想是采用许多形状简单的微小粒子作为基本元素来表示不规则模糊物体。这些粒子都赋予一定的“生命”，它们在系统中都要经历“诞生”、“运动和生长”及“死亡”三个阶段。由于粒子系统是一个有“生命”的系统，因而它不像传统方法那样只能生成瞬时静态景物画面，而可产生一系列运动进化的画面。这使得模拟动态的自然景象成为可能。
传统的基于粒子系统方法的物体模型是用粒子的诞生、活动和死亡三个阶段来描述，并且这三个阶段具有随机性，在某一时刻存活的粒子集合就构成物体模型[5]。
　　(1)粒子的诞生用随机函数控制，第fi帧新诞生粒子数目PN(fi) PN―Particle Number为：

式中rand ( )是[-1, 1]上均匀分布的随机函数， PM (fi)PM―Particle Mean和PV(fi)PV―Particle Variance是第fi帧新诞生粒子数目的平均值和方差，可定义为常数也可定义为变量，如定义

式中f0是粒子系统的初始帧号，PM (f0)和△PM是第f0帧新诞生粒子数目的平均值和变化率，是常数。对新产生的粒子，系统赋予它们一些初始随机属性，如初始运动方向、初始颜色、初始透明度、粒子形状以及生存期等。
粒子的初始位置s(f0)由粒子的诞生区域决定
粒子的初始速度v(f0)=粒子的平均速度mv + rand ( )×
　　　　　　　　　　粒子的速度方差vv
粒子的初始颜色c(f0)=粒子的平均颜色mc + rand ( )×
　　　　　　　　　　粒子的颜色方差vc
粒子的初始透明度t(f0)=粒子的平均透明度mt + rand ( ) ×
　　　　　　　　　　　粒子的透明度方差vt
粒子的生存期l(f0)=粒子的平均生存期ml + rand ( ) ×
　　　　　　　　　粒子的生存期方差vl
　　在计算上述初始属性时，平均值和方差都是用户给定的常数。
　　(2)粒子在它的运动和生长过程中将随机地改变其自身属性。已知fi-1帧时粒子的属性值，则fi帧时粒子的属性值可按下式计算：
位置：  
速度：
颜色：
透明度：
生存期：
式中fi为帧号，i=0，1，2，...，n，当i=0时为粒子的初始属性，a、△c、△t为粒子的加速度、颜色变化率、透明度变化率。可定义为常数。
　　(3)粒子的死亡。粒子诞生时被赋予生存期，该生存期以帧数度量，并随每帧的播放而递减，当减至零时该粒子即死亡，应从粒子系统中删除掉。
3  基于特征的粒子系统建模
　　本节我们将介绍一种利用景物特征的空间相关性，提取特征点简化粒子系统建模的算法。该算法针对不同的不规则的模糊景物，首先勾画景物表面特征，抛弃不可见的内部体，然后就景物表面再提取关键点，以粒子定义它的属性，表面上其余部分的属性通过空间插值得到，下面我们以火焰模型为例，详细介绍这种算法的建模过程。
3.1  火焰的表面特征勾画
　　传统的火焰模型，粒子视作点光源，充满空间的某一区域，同一视线上多个重叠粒子的颜色调配值作为对应象素的颜色，粒子存在的整体空间作为火焰的存在空间[5]。而改进的算法仅考虑景物可见的表面特性，将景物视作一个中空的面物体，此时景物表面特性是融合了内部属性后的特性，是火焰整体所表现的属性。这就要求在进行表面勾画时，必须充分体现景物所表现的外部形状和色彩。
　　在火焰的模拟中，由于自然界存在的真实火焰形状和色彩是不定和动态的，无法以一种简单同一的模型定义，因而我们将它细分，以火苗作为火焰的构成单元。根据我们对自然界火焰的直观观察，提取火焰基本特征，定义火苗的空间基本形状如图1。采用一端平滑，一端较为尖锐的纺锤体模拟火苗的基本形状，中轴线将控制火苗在动态变形中的整体扭曲效果。考虑到算法的实时性，对空间曲面的定义不用函数的形式，而是预先计算曲面某些特征点的空间坐标，定义时以赋值的方法直接规定它的大致外形。火苗表面的颜色基本分布为：焰底是较为明亮的白、黄色，火焰中段由黄渐红过渡，焰顶颜色逐渐变黑，整体颜色分布呈连续的过渡形式。

图1火苗基本形状和颜色分布
　　为了简化运算，火苗表面采用简单的三角剖分，三角形的顶点也就是曲面表面特征点。一般选择特征点数目为12×16(即将表面分割为12层，每层均为一圆形，在每一个圆形上等间隔取16个点)，这种选法一方面考虑到必须有足够的点以保证其基本外形；另一方面点数过多，将不仅增加运算量，还会因为火焰表面相近的两点相关性减弱，使得在火焰运动时，产生表面毛刺，引起图形失真。至此，我们完成了火焰模型的基本外形勾画。
3.2  真实感火焰生成技术
　　在火苗模型的基本外形基础上，将表面特征点按一定规则定义为具备一定属性的发光粒子，实现火苗表面的随机扰动。再加入火苗整体的空间扭动参量Space_Offset ( )，生成真实感图形，具体实现的关键技术有：
　　(1)粒子的属性参数(包括粒子的空间位置、运动方向、运动速度、颜色、透明度和生存期)的确　定。本文第一节已经介绍过这些参数的基本确定方法。对应本算法，不同点在于：粒子的基本属性由该粒子对应的特征点的基本性质决定，它的变动只是一定范围内的随机扰动；一旦有某一个粒子死亡，将立即诞生一个新的粒子以对应该特征点，即粒子的数目在整个运动过程中保持恒定。
　　(2)特征点的空间位置最终是由粒子的位置参数和火苗整体扰动位置参数合成的结果。

其中Pi：第i个粒子；Lj：粒子Pi所在的层；
　　对应特征点的最终空间位置向量；
　　粒子自身的位置向量；
　　所在层的空间偏移向量(特别是它只有两个方向的自由度)。
　　(3)粒子在新诞生时颜色值为对应特征点的基本颜色，在活动过程中，颜色的各分量变化如图2。R、G、B分量均为分段线性函数，保证了粒子颜色的变化规律为：白→黄→红→黑。粒子透明度的变化规律是由生成时完全不透明渐变到死亡时完全透明。

图2粒子颜色的各分量变化
该算法流程描述如下：
PROCEDURE Flame_Building;
  BEGIN
　　初始化特征点的空间坐标和颜色值;
　　相应所有特征点生成粒子;
　　初始化Flame的整体偏移参量Space_Offset; 
　　WHILE  (Not_Quit) DO
　　BEGIN
　　根据当前粒子属性并融合Space_Offset刷新显示Flame;
　　修改粒子属性参数; 
　　IF 有粒子的生存期 1ife=0 THEN
　　BEGIN
　　　　删除该粒子; 
　　　　对应特征点生成新粒子; 
　　END: {if}
　　修改整体空间偏移参量Space_Offset;
　　Waiting (Time);
　　END; {while}
　　END; {Flame_Building}
4  实验结果
　　本算法已在微机上实现。微机硬件配置：CPU―Pentium 166、RAM―32M、显存―4M、显卡类型一S3 ViGRE-DX/GX PCI (375/385)；软件环境：VC++软件开发平台、OpenGL。图3(a)是显示的单一火苗不同时刻的图形；图3(b)是多个火苗分布在空间不同位置组合而成的火焰图形。单个火苗128×128的动态图形显示刷新率可达每秒20帧左右，基本满足实时性要求，并已应用于作战模拟系统中的飞机尾焰等的模拟。由得到的效果看，本算法在满足一定逼真度的条件下很好地解决了不规则模糊动态景物的实时生成显示问题。

图3
5  结论
　　本文介绍了一种基于景物特征的粒子系统建模方法，该方法成功解决了微机环境下动态不规则模糊景物的实时生成和显示。与传统的粒子系统建模方法不同，本方法是先对自然景物提取特征点，然后将特征点用粒子系统表达，利用景物特征的空间相关性，描绘景物整体造型。最后，我们以火焰的建模为实例，描述了算法流程和实验结果。该技术具有很强的应用背景，可方便地融入到各个三维动画系统中。
杨冰(国防科技大学电子工程学院ATR实验室  长沙 410073)
鲁敏(国防科技大学电子工程学院ATR实验室  长沙 410073)
参考文献
1，Blinn J F, Simulation of Wrinkled Surfarces. Computer Graphics, 1978, 12(3): 286～292
2，Reeves W T. Particle System - a Technique for Modeling a Class of Fuzzy Objects. Computer Graphics, 1983, 17(3): 359～376
3，Reeves W T, et al.  Approximate and Probabilistic Algorithms for Shading and Rendering Structured Particle System.  Computer Graphics, 1985, 19(3): 313～322
4，Jos Stam, Eugene Fiume. Depicting Fire and Other Gaseous Phenomena Using Diffusion Processes.  Computer Graphics Proceedings, Annual Conference Series, 1995: 129～136
5，宋万寿, 赖建伟. 基于粒子系统方法的焰火及树木模拟. China JCAD&amp;CG, 1996, 8(4): 254～258
6，唐荣锡等. 计算机图形学教程. 北京: 科学出版社, 1990
收稿日期：1999－11－25
