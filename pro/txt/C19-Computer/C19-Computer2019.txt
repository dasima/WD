微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
1999年 第18卷 第4期 Vol.18 No.4 1999



Windows应用程序的软件测试驱动程序设计
毛法尧　兰毓华　曹化工
　　摘　要：一种针对Windows应用程序特点的测试驱动程序设计方法，利用此方法再结合具体被测程序特点就可以很快得到测试所需的驱动程序。
　　关键词：软件测试　Windows应用程序　驱动程序
　　软件测试是保证软件质量和可靠性的重要手段，其核心是在输入域中选择具有代表性的输入数据来驱动被测程序运行，观察程序的执行结果，做出相应的判断和处理。然而在进行软件测试的时候，必须有1个驱动程序来驱动被测程序运行。驱动程序相当于1个主程序，它接收不同的测试数据，并把这些数据传递给被测程序驱动其运行。如图1所示，驱动程序和桩块程序构成1个软件测试的运行环境。


图1　软件测试运行环境
　　以前基于DOS的应用程序是1种结构化程序，被测程序可以看作是1个子程序直接被驱动主程序调用，并在调用时将测试数据传递给被测程序，然而现在绝大部分应用程序是基于Windows的面向对象程序，采用的是交互式图形界面，程序的输入、输出是基于图形界面交互式完成。程序的执行实际上是执行1个由消息连接起来的方法序列，而这个方法序列往往是由外部事件驱动的，也就是说要实现把测试数据传递给被测程序，并驱动其运行，要求驱动程序能够启动、引导、执行被测程序，并在适当时候将测试数据传给被测程序。下面从Windows程序结构特点和运行机制来探讨实现Windows应用程序的驱动程序设计方法。
1　组成及工作原理
　　1个Windows应用程序是由WinMain函数、窗口函数和其它应用函数组成的，WinMain函数是Windows应用程序入口点，1个应用程序在启动时，是通过调用1个由编辑器提供的启动例程开始工作的，启动例程在完成一些必要的初始化工作后，再调用WinMain函数，使应用程序开始正常工作状态，即进入消息循环阶段。在消息循环阶段，Windows应用程序通过执行一段称为消息循环的代码来轮询应用程序的消息队列，从中检索出该程序要处理的消息，并立即将检索到的消息发送到有关对象上，执行相应的窗口函数完成相应的工作。由此可见，要驱动被测程序运行，驱动程序首先必须调用被测程序的启动例程来完成必要的初始化工作，然后再调用WinMain函数进入正常工作状态，即需要1个启动模块来完成启动工作。又由于Windows应用程序往往有多个窗口，而要传送的测试数据是其中某一个或几个窗口。因此，必须要有1个引导模块来引导被测程序运行到要接收测试数据的窗口，然后将测试数据传送给被测程序，并执行测试过程。综上所述驱动程序应由启动被测程序、引导被测程序、传送测试数据和执行测试模块组成。如图2所示。


图2　驱动程序组成
2　实现方法
2．1　启动被测程序
　　要启动1个被测程序可通过调用LoadModule()函数来实现，LoadModule()的定义如下：
INTLoadModule(lpszModuleName,lpvParamterBlock)
LPCSTRlpszModuleName；要装载文件名地址
LPVOIDlpvParamterBlock；用于新模块的参数块地址
2．2　引导被测程序
　　驱动程序要引导被测程序完成相应的操作，可采用SendMessage()函数向被测程序消息队列中发送相关消息来实现。SendMessage()函数定义如下：
　　LRESVLTSendMessage(hwnd,umsg,wparam,lparam)
　　HWNDhwnd：目标窗口句柄，如此参数为HWNDBROADCAST，则该消息将被送到所有顶层窗口，包括无效或不可见的无主窗口。
　　UINTumsg：要发送的消息。
　　WPARAMwparam：第一消息参数，说明与消息有关的16位附加信息。
　　LPARAMlparam：第二消息参数，说明与消息有关的32位附加信息。
　　该函数将指定的消息发送到指定的窗口或所有窗口，它调用所有窗口的窗口函数并且在窗口函数处理完消息后才返回。
　　从上述定义可以看出驱动程序可根据被测程序的结构和操作顺序，依次用SendMessage()函数向被测程序消息队列中发消息，来引导被测程序到达待测试项目的所在窗口。例如，调用SendMessage()函数将EMSETSEL消息发送到多行编辑控制，通知它选择所有的文字，接着调用SendMessage()函数将拷贝选择文字的WMCOPY消息发送到裁剪板。
SendMessage(hwndml,EMSETSEL,0,MAKELONG(0,-1)；
SendMessage(hwndml,WMCOPY,0,01)；
2．3　传送测试数据
　　根据软件测试的特点，测试数据可能是1组数据、1个字符串、1个控制事件等。如果要使测试过程自动进行，可在被测程序中加上按WindowsDDE协议设计接收测试数据的接口，驱动程序也按DDE协议将测试数据通过wparam和lparam参数来传送数据。在进行黑盒测试时，由于不知被测程序内部详细结构，一般情况下，应由测试人员输入测试数据。
2．4　执行测试
　　在给被测程序传送了测试数据后，可通过SendMessage()函数发执行测试过程的消息，被测程序接收到消息后，执行相应的窗口函数完成测试过程。
3　结束语
　　本文提出的测试驱动程序设计方法，既适合于基于结构的白盒测试，又适合于基于功能的黑盒测试，同时它适合于面向对象的程序方法级、类级、簇级、系统级测试［3］。当然，要得到一个实用的测试驱动程序还需软件设计人员提供有关的信息(如窗口句柄、消息)。
作者单位：武汉华中理工大学计算机学院(430074)
参考文献
　1　杨亮，万玉丹，魏晋鹏.Windows深入剖析――内核篇.北京：清华大学出版社，1997
　2　Microsoft公司.MicrosoftWindows3.1，程序员参考大全(二)――函数.北京：清华大学出版社，1993
　3　金凌紫.面向对象软件测试技术进展.计算机研究与发展，1998；(1)
收稿日期：1998-10-17
