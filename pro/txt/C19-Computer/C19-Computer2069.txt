计算机工程
COMPUTERENGINEERING
1999年第25卷第5期Vol.25No.51999



基于80C196的HSI替代串行口数据采集与处理系统
史清华
摘要 提出了一个高性能Intel 80C196特有的HSI替代串行输入中多通道串行数据采集与处理系统的设计方案，并介绍了与该方案相匹配的信号捕捉，位同步及差错控制算法。
关键词 数据采集 HSI 监控 同步数据 校对
The HSI Replaces Serial Port Data Sample and Process System Bases on 80C196
Shi Qinghua
（Department of Computer Science and Technology ，Shandong University of Technology Jian 250061）
[Abstract]the article demonstrates the designing plan of HIS Replaces Serial Port Multichannel Serial Data Sample and Processing System bases on high performance Intel 80C196，and takes detailed discussion about signal capture ，bit synchronization and error control method。
[Key words ] Data sample；HSI；Supervisory；Synchronization data；Cahecking 
　　在工业控制领域，由于I/O接口在空间上分布的离散性以及站点多、数据量大等特点，现场数据既需要就地和实时的处理，又需要远动中心的监视与遥控；因此，用多个CPU构成分布式监控系统已成为过程控制技术发展的必然趋势。为了提高整个监控网的质量，有利于分站数量的灵活扩充，采用新一代Intel 80C196 CPU所特有的4路HSI通道替代串行输入口的设计手段，同步通信的软件位锁相算法具有一定特色，保证了新一代监控网的各方面要求。
1 通用多路数据采集与处理系统的设计与实现
1.1 硬件设计
　　在分布式监控系统中，各工作站点数据的产生具有并发特点，因此，采集单元应采用集中、并行的数据接收方式；若用常规方法利用串行通信芯片8251实现多通道接收，硬件开销较大；并且系统CPU被频繁中断，会影响系统程序的运行效率，当RTU数量增多时，甚至会产生瓶颈阻塞现象。因此，本系统使用一片80C196 CPU代替4片8251，设计了4通道数据采集与处理系统。该系统可同时接收4个通道传送来的信息，设计允许的数据传送速率为300/1200波特。多通道数据采集与处理系统(采集单元)原理框图(见图1)，完成以下任务：

图1多通道数据采集与系统原理框图（略去键盘与LED电路）
　　(1)多路模/数转换；
　　(2)多路串行同步数据接收；
　　(3)软件完成位锁相并在失步的情况下自动搜索同步字头；
　　(4)支持向工业控制通信网传送实时数据信息(具备两种标准串行接口)。
　　采用ACH4端做为模似量的输入口，使用了多个14051多路选择器，可输入1-64路的模拟信号；而由于输入的是-5-+5V交流模拟信号，所以加两个LF347作放大调整，使输入电压限制在0-5V之间，这符合ACH4端的电平输入标准。系统采用软件轮询的方式进行多路A/D转换，80C196芯片的A/D转换时间为22μs，假如每路进行16次采样以计算有效值，采样定时标准是1.25ms，则16路模拟信号轮询一遍需320ms。实际上，80C196的A/D转换允许更多次采样以求出更精确值。另外，还配备了两种串行通信接口--RS-422和RS-232标准接口。其中R-422接口允许以不低于9600b/s的数据传输速率进行较强干扰下的中近距离通信，其传送和接收数据由P2.5端的电平控制。
　　利用80C196特有的高速输入口HSI.0-HSI.3进行基带信号或是经解调或去干扰以后的串行同步信号的接收工作，这一新颖的尝试是本系统的关键技术措施。它的接收过程是否正确可靠，将直接影响该系统是否能正常运转。从硬件上看，串行同步信号在输入HSI口之前，实施了以下抗干扰措施：4路信号经过解调，又经过一个带回滞曲线特性的施密特或门，已基本上滤掉了杂波和干扰信号，输入到HSI口的数据信号，其信号的捕捉和位锁相过程以及在失步状态下的命令头自动捕捉等处理措施，都将由监控软件来完成。
1.2 HIS端口用作串行输入口的实用软件设计及位同步的实现
　　主监控程序由与各部分硬件功能有关的任务模块组成：主程序负责任务调度，按照一定的优先级轮询各任务，当发现某个任务的有效标志被置位时，程序转去执行该任务，完毕后返回主程序。各任务的有效标志是在不同的中断处理程序中置位的，例如任务5负责处理HSI口的输入数据，该任务的有效标志就是在HSIDATA中断处理程序中被置位。
　　80C196的HSI可用以记录某一外部事件触发时的状态和时刻，共有4路通道，即HSI.0-HSI.3；每个通道的事件触发方式都有4种，而当HSI作为一种替代的串行口来使用时，只有方式3合乎要求。即HSI引脚上每发生一次跳变(无论正负)均能触发HSI数据有效中断(中断向量为2004H)，该中断有两种中断源：FIFO溢出或保持寄存器已装载。为能使通过HSI输入的数据得到及时处理，避免FIFO溢出所产生的数据丢失的现象，本系统指定保持寄存器加载后就产生中断的模式，即事件(电平跳变)一旦发生，则状态和时间送至保持寄存器，并产生中断。在中断处理程序中使用字寄存器PBX记录下定时器HSITIME的值，使用字节寄存器PAH记录下HSISTAT，使用ETIMER寄存器记录下定时器T1的溢出次数，并在每次进入该HSI中断处理程序时对ETIMER作一次调整，以避免T1溢出时的错误计数。为了防止在HSI中断时又有HSI口数据输入，程序采取了相应措施以防数据丢失。记录下的数据被推入QA队列中，同时置上任务标志，然后中断处理程序返回现场。
　　HSI数据处理的工作由任务5完成，见图2。任务5进行串行数据变并行处理，并且用软件完成位锁相；在失步的情况下搜索命令头。在程序中设置了一通道计数器进行HSI4个通道轮流处理时的计数，以保证每一通道输入的数据都能得到及时处理。程序中使用了一种双字移位接收位信息的办法来进行命令头捕捉和数据接收。具体说来就是当本次为上升沿时，则在此以前为低电平，所以接收数据"0"。反之，本次是下降沿时，则接收数据"1"。系统每次检测到串行队列中的"0"到"1"，跳变时(或者"1"到"0"跳变)，便记下此处的当前相位，由于收发两端时钟不可能绝对同步，经过一段时间后，收端相对相位必然发生漂移，而不是每次间隔标准时间(由波特率决定)才进行跳变。如果在程序中检测到串行队列中由"0"到"1"，就把上次相位与当前相位进行比较，取其差值，再与标准间隔时间进行比较，若第一次超过标准间隔时间，则按差值加权算法进行小调整，使相位向前微调；若是连续多次超过标准时间，则进行较大调整。若当前相位与上次相位的差值小于标准间隔时间，则说明相位超前；若是第一次超前，使相位向后微调，若是连续多次不够减，则使相位向后作较大调整。若上次相位与当前相位之差等于标准时间间隔，则说明收发两端完全同步而不必进行相位调整。这样，用软件方法实现了收发两端的位同步。

图2 HSI数据处理程序
2 通信信息的检错、纠错及解码算法
　　多通道数据采集器接收的各RTU数据，存放在相应的接受队列中等待处理，当程序查询到某队列已满一帧时，则对该帧进行解码处理。首先，用查表法求出该帧前14字节的CRC-16余数并与该帧的后两字节CRC-16检验码比较，若两者相等，说明接收数据正确无误；若不相等，说明该帧有错位，如果错位在可纠正范围内，则进行纠错处理，否则进行错误处理。
　　由于采用的是(128，112)线性循环码，根据抗干扰编码理论中的循环编码原理，(N，K)循环码满足公式：C(X)=M(X)*G(X)=Xn-kM(X)+R(X)
　　其中，C(X)----用循环码编码方法得到的循环码字，即通信中传送的码组。
　　M(X)----待编码的信息多项式K－1。
　　G(X)----次数为N－K的生成多项式；G(X)应选用经理论与实践验证过的推荐式。
　　R(X)----将M(X)左移N－K位后模2除以G(X)所得之余式，也就是CRC校验码。
　　在某些大规模集成电路串行通信芯片中，如Intel8274及82530等集成有一定生成多项式的CRC编码/译码电路，其优点是处理速度快，但可供选择的生成多项式少，难以支持各种复杂的抗干扰编/译码电路的需要，因此，当编码速度要求不高时，多采用软件方法进行抗干扰编码/译码。
　　(N，K)循环抗干扰编码无论是发送端还是接收端，其软件算法是一致的；即以G(X)为除数对Xn-kM(X)做模2除法运算，得到余数R(X)，在发送端将余数R(X)附加在M(X)之后送信道传输即可，在接收端将求出的R(X)与收到的检验码进行比较，若两者一致表示无错，否则帧内码存在误差。
　　(N，K)循环码的软件求余数的常规方法是将M(X)左移K次，每次移出的最高位为1时便将上次之部分余式与G(X)进行异或运算，得到本次的部分余数；这样重复K次运算完成时，便得到最终余数R(X)。该算法虽简单，但当信息位较多时(如几百或上千)，会影响编码速度。为了提高对长信息的编译码速度，可用分段查表法来求余数，其具体做法是将信息码分成若干段，根据每段的值查余数表得到一个部分余数，完成各段求解后就得到最终余数。显然，分段越多部分余数占用空间越小，但查表次数增多，运算速度变慢，分段越少余数表占用空间越大，但查表次数变少，运算速度加快。以(118，112)循环码为例，其生成多项式为：G(X)=X16+X12+X5+1，用该生成多项式求得余数为16位，若按16位来分段，则需一长度65536字节的部分余数表，这显然不适用。考虑到80C196指令系统也支持字节操作，且RAM不可能太大，可将X(C)按字节分段并按字节取余数，每个余数查两次表即可获得，这样部分余数表所占内存空间只有512字节，这在实际中是完全可行的。
　　字节求余数法比字求余数法多了一些操作步骤但所需的存储空间大大减少了，它通过增加运算时间的减少存储量，是比直接求余数法更快的一种实用算法。
3 结语
　　(1)提出的基于Intel80C196的多路数据采集与处理系统及配套软件设计，能够满足现场通信的要求并具有一定的通用性，其硬件电路结构清晰简练，具有很高的性能价格比，且处理数据精度高，是一种通用性、实用性很强的多通道通信接收系统。
　　(2)所介绍的软件位锁相算法，使收发两端的晶振频率不稳定度或通信波特率偏差允许范围是－0.5%-+0.5%，因此该方法是完全实用的。
　　(3)介绍的分布式局域网监控系统已在山东省电力系统下属单位及生产企业等多处得到实际应用，证明性能可靠，效果良好，被认为值得进一步推广。
作者简介：史清华 男，32岁，讲师，主要研究计算机网络，数据通信，自动控制等
作者单位：山东工业大学计算机科学技术系 济南 250061
参考文献
1 Intel.Microcommunications Handbook.USA：Intel Corp,1993
2 WyattA L.Using Assembly Language.USA: QUE Corporation,1992
3 Intel.Embedded Microcontrollers and Processors Vol.I. USA：Intel Corp，1993
4 张迎新.单片微型计算机原理、应用及接口技术.北京：国防工业出版社，1993-12
5 潘新民.单片微型计算机实用系统设计.北京：人民邮电出版 社，1996
收稿日期：1998-12-01
